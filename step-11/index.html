
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>11 Variables again Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.0.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../step-12/" />
    
    
    <link rel="prev" href="../step-10/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../step-00/">
            
                <a href="../step-00/">
            
                    
                    00 Vagrant Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../step-01/">
            
                <a href="../step-01/">
            
                    
                    01 Basic inventory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../step-02/">
            
                <a href="../step-02/">
            
                    
                    02 First modules and facts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../step-03/">
            
                <a href="../step-03/">
            
                    
                    03 Groups and variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../step-04/">
            
                <a href="../step-04/">
            
                    
                    04 Playbooks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../step-05/">
            
                <a href="../step-05/">
            
                    
                    05 Playbooks, pushing files on nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../step-06/">
            
                <a href="../step-06/">
            
                    
                    06 Playbooks and failures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../step-07/">
            
                <a href="../step-07/">
            
                    
                    07 Playbook conditionals
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../step-08/">
            
                <a href="../step-08/">
            
                    
                    08 Git module
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../step-09/">
            
                <a href="../step-09/">
            
                    
                    09 Extending to several hosts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../step-10/">
            
                <a href="../step-10/">
            
                    
                    10 Templates
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.13" data-path="./">
            
                <a href="./">
            
                    
                    11 Variables again
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../step-12/">
            
                <a href="../step-12/">
            
                    
                    12 Migrating to roles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../step-13/">
            
                <a href="../step-13/">
            
                    
                    13 Using tags
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../step-14/README.md">
            
                <a href="../step-14/README.md">
            
                    
                    14 Roles dependencies (TBD)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../step-15/README.md">
            
                <a href="../step-15/README.md">
            
                    
                    15 Debugging (TBD)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../step-99/README.md">
            
                <a href="../step-99/README.md">
            
                    
                    99 The end
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >11 Variables again</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="ansible-tutorial-variables-again">Ansible tutorial: Variables again</h1>
<p>So we&apos;ve setup our loadbalancer, and it works quite well. We grabbed variables
from facts and used them to build the configuration. But Ansible also supports
other kinds of variables. We already saw <code>ansible_host</code> in inventory, but now
we&apos;ll use variables defined in <code>host_vars</code> and <code>group_vars</code> files.</p>
<h2 id="fine-tuning-our-haproxy-configuration">Fine tuning our HAProxy configuration</h2>
<p>HAProxy usually checks if the backends are alive. When a backend seems dead, it
is removed from the backend pool and HAproxy doesn&apos;t send requests to it
anymore.</p>
<p>Backends can also have different weights (between 0 and 256). The higher the
weight, the higher number of connections the backend will receive compared to
other backends. It&apos;s useful to spread traffic more appropriately if nodes are
not equally powerful.</p>
<p>We&apos;ll use variables to configure all these parameters.</p>
<h2 id="group-vars">Group vars</h2>
<p>The check interval will be set in a group_vars file for haproxy. This will
ensure all haproxies will inherit from it.</p>
<p>We just need to create the file <code>group_vars/haproxy.yml</code> below the inventory
directory. The file has to be named after the group you want to define the
variables for. If we wanted to define variables for the web group, the file
would be named <code>group_vars/web.yml</code>.</p>
<p>Note that the <code>.yml</code> is optionalm: we could name haproxy group vars file
<code>group_vars/haproxy</code> and Ansible would be ok with it. The extension just helps
editors picking the right syntax highlighter.</p>
<pre><code class="lang-jinja"><span class="xml">haproxy_check_interval: 3000
haproxy_stats_socket: /tmp/sock
</span></code></pre>
<p>The name is arbitrary. Meaningful names are recommended of course, but there is
no required syntax. You could even use complex variables (a.k.a. Python dict)
like this:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">haproxy:</span>
<span class="hljs-attr">    check_interval:</span> <span class="hljs-number">3000</span>
<span class="hljs-attr">    stats_socket:</span> /tmp/sock
</code></pre>
<p>This is just a matter of taste. Complex vars can help group stuff logically.
They can also, under some circumstances, merge subsequently defined keys (note
however that this is not the default ansible behaviour). For now we&apos;ll just use
simple variables.</p>
<h2 id="hosts-vars">Hosts vars</h2>
<p>Hosts vars follow exactly the same rules, but live in files under <code>host_vars</code>
directory.</p>
<p>Let&apos;s define weights for our backends in <code>host_vars/host1.example.com</code>:</p>
<pre><code class="lang-ini">haproxy_backend_weight: 100
</code></pre>
<p>and <code>host_vars/host2.example.com</code>:</p>
<pre><code class="lang-ini">haproxy_backend_weight: 150
</code></pre>
<p>If we&apos;d define <code>haproxy_backend_weight</code> in <code>group_vars/web</code>, it would be used
as a &apos;default&apos;: variables defined in <code>host_vars</code> files overrides variables
defined in <code>group_vars</code>.</p>
<h2 id="updating-the-template">Updating the template</h2>
<p>The template must be updated to use these variables.</p>
<pre><code class="lang-jinja"><span class="xml">global
    daemon
    maxconn 256
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">if</span></span> haproxy_stats_socket %}</span><span class="xml">
    stats socket </span><span class="hljs-template-variable">{{ haproxy_stats_socket }}</span><span class="xml">
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endif</span></span> %}</span><span class="xml">

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

listen cluster
    bind </span><span class="hljs-template-variable">{{ ansible_all_ipv4_addresses.1 }}</span><span class="xml">:80
    mode http
    stats enable
    balance roundrobin
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> backend <span class="hljs-keyword">in</span> groups[&apos;web&apos;] %}</span><span class="xml">
    server </span><span class="hljs-template-variable">{{ hostvars[backend][&apos;ansible_hostname&apos;] }}</span><span class="xml"> </span><span class="hljs-template-variable">{{ hostvars[backend].ansible_all_ipv4_addresses.1 }}</span><span class="xml"> check port 80
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">
    option httpchk HEAD /index.php HTTP/1.0
</span></code></pre>
<p>Note that we also introduced an <code>{% if ...</code> block. This block enclosed
will only be rendered if the test is true. So if we define
<code>haproxy_stats_socket</code> somewhere for our loadbalancer (we might even use the
<code>--extra-vars=&quot;haproxy_stats_sockets=/tmp/sock&quot;</code> at the command line), the enclosed
line will appear in the generated configuration file (note that the
suggested setup is highly insecure!).</p>
<p>Let&apos;s go:</p>
<pre><code class="lang-bash">ansible-playbook -i step-11/hosts step-11/haproxy.yml
</code></pre>
<p>Note that, while we could, it&apos;s not necessary to run the apache playbook since
nothing changed, but we had to cheat a bit for that. Here is the updated
haproxy playbook:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">- hosts:</span> web
<span class="hljs-attr">  gather_facts:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">- hosts:</span> haproxy
<span class="hljs-attr">  tasks:</span>
<span class="hljs-attr">    - name:</span> Installs haproxy load balancer
<span class="hljs-attr">      apt:</span>
<span class="hljs-attr">        pkg:</span> haproxy
<span class="hljs-attr">        state:</span> present
<span class="hljs-attr">        update_cache:</span> <span class="hljs-literal">yes</span>

<span class="hljs-attr">    - name:</span> Pushes configuration
<span class="hljs-attr">      template:</span>
<span class="hljs-attr">        src:</span> templates/haproxy.cfg.j2
<span class="hljs-attr">        dest:</span> /etc/haproxy/haproxy.cfg
<span class="hljs-attr">        mode:</span> <span class="hljs-number">0640</span>
<span class="hljs-attr">        owner:</span> root
<span class="hljs-attr">        group:</span> root
<span class="hljs-attr">      notify:</span>
<span class="hljs-bullet">        -</span> restart haproxy

<span class="hljs-attr">    - name:</span> Sets default starting flag to <span class="hljs-number">1</span>
<span class="hljs-attr">      lineinfile:</span>
<span class="hljs-attr">        dest:</span> /etc/default/haproxy
<span class="hljs-attr">        regexp:</span> <span class="hljs-string">&quot;^ENABLED&quot;</span>
<span class="hljs-attr">        line:</span> <span class="hljs-string">&quot;ENABLED=1&quot;</span>
<span class="hljs-attr">      notify:</span>
<span class="hljs-bullet">        -</span> restart haproxy

<span class="hljs-attr">  handlers:</span>
<span class="hljs-attr">    - name:</span> restart haproxy
<span class="hljs-attr">      service:</span>
<span class="hljs-attr">        name:</span> haproxy
<span class="hljs-attr">        state:</span> restarted
</code></pre>
<p>See? We added an empty play for web hosts at the top. It does nothing except
<code>gather_facts: true</code>. But it&apos;s here because it will trigger facts gathering on
hosts in group <code>web</code>.  This is required because the haproxy playbook needs to
pick facts from hosts in this group. If we don&apos;t do this, ansible will complain
saying that <code>ansible_all_ipv4_addresses</code> key doesn&apos;t exist.</p>
<p>Note that we already did that in the previous step, but we did not mention it.</p>
<p>Now on to the next chapter about &quot;Migrating to Roles!&quot;, in
<a href="https://github.com/leucos/ansible-tuto/tree/master/step-12" _target="blank">step-12</a>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../step-10/" class="navigation navigation-prev " aria-label="Previous page: 10 Templates">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../step-12/" class="navigation navigation-next " aria-label="Next page: 12 Migrating to roles">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"11 Variables again","level":"1.13","depth":1,"next":{"title":"12 Migrating to roles","level":"1.14","depth":1,"path":"step-12/README.md","ref":"step-12/README.md","articles":[]},"previous":{"title":"10 Templates","level":"1.12","depth":1,"path":"step-10/README.md","ref":"step-10/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"3.0.x","theme":"default","variables":{},"plugins":["-sharing","edit-link@2.0.x","github@2.0.x"],"pluginsConfig":{"edit-link":{"base":"https://github.com/leucos/ansible-tuto/edit/master","label":"Edit"},"github":{"url":"https://github.com/leucos/ansible-tuto"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"step-11/README.md","mtime":"2020-05-25T23:38:30.306Z","type":"markdown"},"gitbook":{"version":"3.0.3","time":"2020-05-25T23:48:43.246Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/buttons.js"></script>
        
    

    </body>
</html>

